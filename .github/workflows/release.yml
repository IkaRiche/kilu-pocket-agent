name: Android Release

on:
  push:
    tags:
      - 'v*' # Trigger on tags like v0.3.6

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate VersionCode Increment
        run: |
          # Ensure versionCode is increasing monotonically
          LATEST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "none")
          if [ "$LATEST_TAG" != "none" ]; then
            git checkout $LATEST_TAG
            PREV_VERSION_CODE=$(grep -o 'versionCode = [0-9]*' app/build.gradle.kts | awk '{print $3}' || echo "0")
            git checkout -
            CURR_VERSION_CODE=$(grep -o 'versionCode = [0-9]*' app/build.gradle.kts | awk '{print $3}')
            
            if [ "$CURR_VERSION_CODE" -le "$PREV_VERSION_CODE" ]; then
              echo "Error: versionCode ($CURR_VERSION_CODE) is not greater than previous release ($PREV_VERSION_CODE)"
              exit 1
            fi
            echo "VersionCode strictly monotonically increased from $PREV_VERSION_CODE to $CURR_VERSION_CODE!"
          else
            echo "First release tag. Skipping previous checking."
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle Cache
        uses: gradle/gradle-build-action@v2

      - name: Generate Keystore
        env:
          KILU_RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KILU_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KILU_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          keytool -genkey -v -keystore app/release.jks -keyalg RSA -keysize 2048 -validity 10000 -alias "$KILU_RELEASE_KEY_ALIAS" -storepass "$KILU_RELEASE_STORE_PASSWORD" -keypass "$KILU_RELEASE_KEY_PASSWORD" -dname "CN=KiLu Agent, OU=Mobile, O=KiLu Network, L=Unknown, S=Unknown, C=US"

      - name: Build ProdRelease APK
        env:
          KILU_RELEASE_STORE_FILE: "release.jks"
          KILU_RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KILU_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KILU_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: ./gradlew clean :app:assembleProdRelease

      - name: Generate Checksums and Prepare Artifacts
        run: |
          APK_PATH="app/build/outputs/apk/prod/release/app-prod-release.apk"
          if [ -f "$APK_PATH" ]; then
            sha256sum "$APK_PATH" > SHA256SUMS.txt
            cp "$APK_PATH" .
            # Format the output just to be absolutely clean with strictly the basename
            SHA256_HASH=$(awk '{print $1}' SHA256SUMS.txt)
            echo "$SHA256_HASH  app-prod-release.apk" > SHA256SUMS.txt
          else
            echo "Error: APK not found at $APK_PATH"
            exit 1
          fi

      - name: Extract Release Notes from Changelog
        id: parse_changelog
        run: |
          # Very basic parsing: extracts lines between the current version and the previous one
          VERSION_RAW=${GITHUB_REF#refs/tags/v}
          if [ -f "CHANGELOG.md" ]; then
            awk "/^## \\[$VERSION_RAW\\]/{flag=1; next} /^## \\[[0-9]/{flag=0} flag" CHANGELOG.md > release_notes.txt
          else
            echo "Automated release builder for KiLu Pocket Agent ($GITHUB_REF)." > release_notes.txt
          fi

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            app-prod-release.apk
            SHA256SUMS.txt
          body_path: release_notes.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
